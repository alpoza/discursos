---
title: "TextMining - Discursos Presidenciales tidy way"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r libraries, message=FALSE, warning=FALSE}
library (tidyverse)
library (tidytext)
library (ggrepel)
library (tm)
```
```{r read_data, message=FALSE, warning=FALSE}
filenames <- list.files(".",pattern="*.txt")
discursos_raw = map(filenames,~readLines(.x,encoding="UTF-8")) %>% 
  map2(filenames, ~tibble(text=.x, docid=.y)) %>% 
  map_df(rbind)

# Replaces varios
discursos_raw = discursos_raw %>% 
  filter(text != "") %>% 
  mutate(text = gsub("SS.SS", "Sus_Señorías", text)
         ,text = gsub("SS. SS", "Sus_Señorías", text)
         )
discursos_raw 
```

```{r tyding, message=FALSE, warning=FALSE}
discursos = discursos_raw %>%
  group_by(docid) %>%
  mutate(linenumber = row_number()) %>% 
  ungroup() %>% 
  unnest_tokens(word, text) 

add.stops=c(
  "vez", "sino", "cada", "ello", "así", "sólo", "digo", 
  "que", "que,", "señorías","gobierno",
  "españa","españoles","país","ser","hacia","años",
  "debe","cualquier","año","manera","todas","mayor",
  "parte","presidenta","ustedes","vista","señora","hecho","sus")
add.stops=c("kk")
stop_words = append(add.stops, tm::stopwords("spanish"))

discursos = discursos %>% 
  filter(!word %in% stop_words) 

discursos_tfidf = discursos %>% 
  count(docid, word, sort = TRUE) %>%
  ungroup() %>% 
  bind_tf_idf(word, docid, n) %>% 
  arrange(desc(tf_idf))

discursos_tfidf %>% arrange(desc(n))
```
```{r plots words, message=FALSE, warning=FALSE}
discursos_tfidf %>% 
  group_by(docid) %>% 
  top_n(3) %>% 
  ungroup() %>% 
  arrange(docid) %>% 
  ggplot(aes(word,tf_idf, color=docid)) + 
    geom_label_repel(aes(label=word)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(legend.position="bottom")
```
```{r td-idf words by doc, message=FALSE, warning=FALSE}
plots <- discursos_tfidf %>%
  group_by(docid) %>% 
  top_n(5) %>% 
  ungroup() %>% 
  mutate(word = reorder(word, tf_idf)) %>%
  split(.$docid) %>%
  map(~ ggplot(.x, aes(word,tf_idf)) + 
          geom_bar(stat="identity", aes(fill=docid)) + 
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          theme(legend.position="bottom")
  )

walk(plots, print)
```

```{r tidy bigrams}
discursos_bigram_raw = discursos_raw %>%     
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

add.bigramsstops=c("señora presidenta", "sus señorías")
discursos_bigram_raw = discursos_bigram_raw %>% 
  filter(!bigram %in% add.bigramsstops)
  
discursos_bigram = discursos_bigram_raw %>% 
  separate(bigram, c("word1", "word2"), sep = " ") %>% 
  filter(!word1 %in% stop_words) %>%
  filter(!word2 %in% stop_words) %>% 
  unite(bigram, word1, word2, sep = " ") 

discursos_bigram_tfidf = discursos_bigram %>% 
  count(docid, bigram, sort = TRUE) %>%
  ungroup() %>% 
  bind_tf_idf(bigram, docid, n) %>% 
  arrange(desc(tf_idf))

discursos_bigram
```
```{r plots bigrams, message=FALSE, warning=FALSE}
discursos_bigram_tfidf %>% 
  group_by(docid) %>% 
  top_n(3) %>% 
  ungroup() %>% 
  mutate(bigram = reorder(bigram, tf_idf)) %>%
  ggplot(aes(bigram,tf_idf, color=docid)) + 
    geom_label_repel(aes(label=bigram)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    theme(legend.position="bottom")
```
```{r td-idf bigrams by doc, message=FALSE, warning=FALSE}
plots <- discursos_bigram_tfidf %>%
  group_by(docid) %>% 
  top_n(5) %>% 
  ungroup() %>% 
  mutate(bigram = reorder(bigram, tf_idf)) %>%
  split(.$docid) %>%
  map(~ ggplot(.x, aes(bigram,tf_idf)) + 
          geom_bar(stat="identity", aes(fill=docid)) + 
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          theme(legend.position="bottom")
  )

walk(plots, print)
```

```{r, message=FALSE, warning=FALSE}
require(quanteda)

pcorpus = corpus(discursos_raw%>% 
                   split(.$docid) %>% 
                   map(~ paste0(.x, collapse = " ")) %>% 
                   map_chr(~ paste0(.x,collapse= " ")))
options(width = 200)
kwic(pcorpus, "iraq")

```

```{r, message=FALSE, warning=FALSE}
dfm = discursos_tfidf %>% select(docid, word, n) %>% cast_dfm(docid, word, n)
topfeatures(dfm, 20)
```
```{r, message=FALSE, warning=FALSE}

filterwords = c("constitución", "empleo", "crisis", "españa","desempleo","paro","nación","pais","cataluña","trabajo","eta","vasco","pacto","autónomas","terrorismo","terrorista","terroristas","europa","europea","corrupción", "corrupto","gal","atentado", "atentados","droga","drogas")

pscale = discursos_tfidf %>% 
  group_by(docid) %>%
  mutate(docid_total = sum(n)) %>% 
  ungroup() %>% 
  filter(word %in% filterwords) %>%
  ggplot(aes(docid, n/docid_total)) +
    geom_bar(stat="identity", aes(fill=docid)) +
    geom_smooth() +
    facet_wrap(~ word, scales = "free_y") +
    scale_y_continuous(labels = scales::percent_format()) +
    ylab("% frequency of word in inaugural address") +
      theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank()) +
      theme(legend.position="bottom"
            ,legend.direction="horizontal"
            ,legend.key.width = unit(1, "mm") ) +
      theme(legend.position = 'none')

pnoscale = discursos_tfidf %>% 
  group_by(docid) %>%
  mutate(docid_total = sum(n)) %>% 
  ungroup() %>% 
  filter(word %in% filterwords) %>%
  ggplot(aes(docid, n/docid_total)) +
    geom_bar(stat="identity", aes(fill=docid)) +
    geom_smooth() +
    facet_wrap(~ word) +
    scale_y_continuous(labels = scales::percent_format()) +
    ylab("% frequency of word in inaugural address") +
      theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank()) +
      theme(legend.position="bottom"
            ,legend.direction="horizontal"
            ,legend.key.width = unit(1, "mm") ) +
      theme(legend.position = 'none')

pscale
pnoscale


```
```{r terrorismo, message=FALSE, warning=FALSE}

terrorismo_keywords = c("atentad*","terror*","eta","gal","yihad*","muertos")

#options(width = 400)
#kwic(pcorpus, terrorismo_keywords,window = 15)
#quanteda::textstat_simil (dfm, "00.txt", margin = "documents")
relacion_docs = as.matrix(quanteda::textstat_simil (dfm, margin = "documents", upper=TRUE, diag=TRUE))

terrorismo_terms = as.data.frame(kwic(pcorpus, terrorismo_keywords,window = 10)) %>% select(keyword) %>% mutate(keyword=char_tolower(keyword)) %>% unique() 

library (corrplot)

corrplot(relacion_docs, method = "ellipse", type="lower", order = "alphabet")
corrplot(relacion_docs, method = "pie", type="lower", order = "alphabet")
corrplot(relacion_docs, method = "pie", type="lower", order = "FPC")
corrplot(relacion_docs, method = "pie", type="lower", order = "AOE")
corrplot(relacion_docs, method = "number", type="lower", order = "hclust")

library(ggcorrplot)
ggcorrplot(relacion_docs, method = "circle", lab=T, lab_size = 3, type="lower", hc.order=T, ggtheme=theme_classic)


```

```{r}
library(treemapify)
```

```{r terms correlation, message=FALSE, warning=FALSE}

#options(width = 400)
#kwic(pcorpus, terrorismo_keywords,window = 15)
#quanteda::textstat_simil (dfm, "00.txt", margin = "documents")
#relacion_words = as.matrix(quanteda::textstat_simil (dfm, margin = "features", upper=TRUE, diag=TRUE))


#corrplot(relacion_words, method = "ellipse", type="lower", order = "alphabet")
#como hablan del terrorismo
discursos %>%
  filter(word %in% terrorismo_terms$keyword) %>%
  ggplot(aes(docid, linenumber)) +
    geom_point (aes(fill=word, color=word ) ) +
    geom_smooth() +
    geom_text_repel(aes(label=word, color=word)) +
    coord_flip() + 
    facet_grid(docid~., scales = "free")

#como hablan del desempleo
discursos %>%
   filter(word %in% c("empleo","desempleo")) %>%
   ggplot(aes(docid, linenumber)) +
     geom_point (aes(fill=word, color=word, shape=word, size=5, alpha=1/4 )) +
     geom_smooth() +
     coord_flip() + 
     facet_grid(docid~., scales = "free")

#lo mismo pintado sin facets
discursos %>% 
    filter(word %in% c("empleo","desempleo")) %>%
    ggplot(aes(docid, linenumber)) +
      geom_count (show.legend = F, aes( color=word, alpha=1/4, shape=word)) +
 coord_flip()
#ggMarginal(p, type = "histogram", fill="transparent")

```
```{r ngrams}

discursos_ngrams = lapply(1:5, function(ngram_n) {
    discursos_raw %>%
    group_by(docid) %>%
    mutate(linenumber = row_number()) %>% 
    ungroup() %>% 
    unnest_tokens(output = word, input = text, token = "ngrams", n = ngram_n) %>% 
    mutate(ngram_n = ngram_n)
 }) %>% bind_rows()

vector.is.empty <- function(x) return(length(x) == 0 )
term.in.list <- function(cadena, lista) return( !vector.is.empty(intersect(unique(unlist(strsplit(cadena, " ", fixed = T))),lista)) )

discursos_ngrams = discursos_ngrams %>% 
  filter(!term.in.list(word, stop_words))
  

discursos_ngrams_dfidf = discursos_ngrams %>%
     count(docid, word, sort = TRUE) %>%
     ungroup() %>%
     bind_tf_idf(term_col = word, document_col = docid, n_col = n)



```
```{r ngrams plot}
discursos_ngrams_dfidf %>% 
  group_by(docid) %>%
  top_n(10) %>% 
  ungroup() %>% 
  mutate(word = reorder(word, tf_idf)) %>%
  split(.$docid) %>%
  map(~ ggplot(.x, aes(word,tf_idf)) + 
          geom_bar(stat="identity", aes(fill=docid)) + 
          theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
          theme(legend.position="bottom")
  )


```
```{r ngram by parrafo}
discursos_ngrams_parrafos_dfidf = discursos_ngrams %>%
    count(docid,linenumber, word, sort = TRUE) %>%
    ungroup() %>% 
    split(c(.$docid)) %>%
    map(~ .x %>% 
     bind_tf_idf(term_col = word, document_col = linenumber, n_col = n)
    ) %>% bind_rows()
```
```{r ngram by parrafo plot}

```



